<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
	<title>Dark Mode Highlighter</title>
	<meta name="author" content="https://orcid.org/xxxx"/>
	<meta name="color-scheme" content="dark light"/>
	<meta name="description" content="Use the slider to adjust a given color's transparency, while attempting to preserve its appearance on a white background. This should allow the same highlight color look good on both light and dark backgrounds."/>
	<meta name="viewport" content="width=device-width"/>
	<style>
		body {
			font-family: "Avenir", "Segoe UI", sans-serif;
			margin: 2rem;
		}
		label {
			background-color: #77B3;
			display: block;
			line-height: 2;
			max-width: 40rem;
			padding: 2rem;
		}
		label b {
			margin-right: 2rem;
		}
		label input {
			width: 100%;
		}
		table {
			width: 100%;
		}
		tbody tr:nth-child(1) {
			background-color: White;
			color: Black;
		}
		tbody tr td {
			font-size: x-large;
			padding: 5vh 5vw;
		}
		tbody tr td::before {
			content: "It was still dark when Stuart ";
		}
		tbody tr td::after {
			content: " out to the car.";
		}
		tbody tr td:nth-child(2) span {
			background-color: var(--start-color);
		}
		tbody tr td:nth-child(3) span {
			background-color: var(--new-color);
		}
		thead tr td {
			text-align: center;
		}
		thead tr:nth-child(2) {
			background-color: #77B3;
		}
	</style>
</head>

<body style="--start-color: MistyRose; --new-color: MistyRose;">
	<h1>Dark Mode Highlighter</h1>
	<p id="desc"></p>
	<table>
		<thead>
			<tr><th></th><th>Start Color</th><th>New Color</th></tr>
			<tr><th>Hex</th><td id="parsed-hex"></td><td id="new-hex"></td></tr>
			<tr><th>Parsed</th><td id="parsed-val"></td><td id="parsed-new"></td></tr>
		</thead>
		<tbody>
			<tr><th>On White</th><td><span id="start-rendered">carried his suitcase</span></td><td><span id="new-rendered">carried his suitcase</span></td></tr>
			<tr><th>On Canvas</th><td><span>carried his suitcase</span></td><td><span>carried his suitcase</span></td></tr>
		</tbody>
	</table>
	<label><b>Start Color</b><input id="start-color" type="text" value="MistyRose" oninput="updateColor()"></input></label>
	<label><b>Target Alpha</b> [ <span id="alpha-int"></span>/255 â‰ˆ <span id="alpha-dec"></span> ]<input id="target-alpha" type="range" min="1" max="255" step="1" value="255" oninput="updateColor()"></input></label>
	<script>//<![CDATA[

String.prototype.pullNumberArray = function () {
	return (this.match(/-?(?:\d*\.)?\d+(?:[eE]-?\d+)?/g) ?? []).map(Number);
};

// components are 3 or 4 integers >= 0 and <= 255
function colorString(components) {
	const c = components[3] == 255 ? components.slice(0, -1) : components.slice();
	const hex = [];
	let shortHex = true;
	let useRGB = false;
	for (let i = 0; i < c.length; ++i) {
		if (c[i] < 0 || c[i] > 255) {
			useRGB = true;
			break;
		}
		hex.push(c[i].toString(16).padStart(2, "0"));
		if (hex[i][0] != hex[i][1]) {
			shortHex = false;
		}
	}
	if (useRGB) {
		if (c.length < 4) {
			return `rgb(${c.join(", ")})`;
		}
		c[3] = (c[3] / 255).toFixed(3);
		return `rgba(${c.join(", ")})`;
	}
	return "#" + (shortHex ? hex.map(x => x[0]) : hex).join("");
}

const colorIn = document.getElementById("start-color");
const alphaIn = document.getElementById("target-alpha");
const startRenderedStyle = window.getComputedStyle(document.getElementById("start-rendered"));
const newRenderedStyle = window.getComputedStyle(document.getElementById("new-rendered"));
const parsedValOut = document.getElementById("parsed-val");
const parsedHexOut = document.getElementById("parsed-hex");
const parsedNewOut = document.getElementById("parsed-new");
const alphaIntOut = document.getElementById("alpha-int");
const alphaDecOut = document.getElementById("alpha-dec");
const colorOut = document.getElementById("new-hex");

function updateColor() {
	document.body.style.setProperty("--start-color", colorIn.value);
	const computedColor = startRenderedStyle.backgroundColor;
	parsedValOut.textContent = computedColor;
	alphaIntOut.textContent = alphaIn.value;
	let startRGBA = computedColor.pullNumberArray();
	const sAlpha = startRGBA[3] ?? 1;
	startRGBA[3] = sAlpha;
	if (computedColor.startsWith("color")) {
		startRGBA = startRGBA.map(x => Math.round(x * 255));
	} else {
		startRGBA[3] = Math.round(startRGBA[3] * 255);
	}
	parsedHexOut.textContent = colorString(startRGBA);
	const newRGBA = new Array(4);
	newRGBA[3] = Number(alphaIn.value);
	const tAlpha = newRGBA[3] / 255;
	alphaDecOut.textContent = tAlpha.toFixed(3);
	// let error = 0;
	for (let i = 0; i < 3; ++i) {
		const ideal = (startRGBA[i] * sAlpha + 255 * (tAlpha - sAlpha)) / tAlpha;
		newRGBA[i] = Math.round(ideal);
		// error += Math.abs(ideal - Math.max(0, Math.min(newRGBA[i], 255)));
	}
	const newHex = colorString(newRGBA);
	document.body.style.setProperty("--new-color", newHex);
	parsedNewOut.textContent = newRenderedStyle.backgroundColor;
	colorOut.textContent = newHex;
}

document.getElementById("desc").textContent = document.querySelector('meta[name="description"]').content;
updateColor();

//]]></script>
</body>

</html>