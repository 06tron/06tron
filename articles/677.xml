<p>With the book club this past semester I read Daphne du Maurier's <cite><a href="https://www.wikidata.org/wiki/Q1334940">Rebecca</a></cite>, Gerald Durrell's <cite><a href="https://www.wikidata.org/wiki/Q1394009">My Family and Other Animals</a></cite>, and most of <a href="https://www.wikidata.org/wiki/Q3993282">Tony Mendez's</a> <cite>Argo</cite>. I also read Cormac McCarthy's <cite><a href="https://www.wikidata.org/wiki/Q264519">All the Pretty Horses</a></cite>.</p>

<section class="software web" id="percent_encode_677">

	<h3><span class="fl">Percent-Encoding Guide</span></h3>

	<p>According to <a href="https://www.rfc-editor.org/info/std66">STD 66 RFC 3986</a><sup>1</sup>, the characters of the string <q><code>!#$&amp;'()*+,/:;=?@[]</code></q> could have a special meaning in a URI and are reserved. The <a href="https://infra.spec.whatwg.org/#ascii-alphanumeric">ASCII alphanumeric</a> characters and those contained in <q><code>-._~</code></q> are unreserved. Any character outside of these two sets must be percent-encoded before inclusion in a URI. This is what the JavaScript <cite>encodeURI()</cite> function does, except that it also encodes the square brackets <q><code>[]</code></q>, which were not yet included in the set of reserved or unreserved characters when the superseded <a href="https://www.rfc-editor.org/info/rfc2396">RFC 2396</a> was written.</p>

	<p>The unreserved characters can always be left unencoded, but we may need to encode a subset of the reserved characters.<sup>2</sup> This subset depends on the URI scheme being used and where in the URI the characters are. The function <cite>encodeURIComponent()</cite> encodes everything except for the characters of <q><code>!'()*</code></q>, which might not need to be encoded as they weren't yet reserved in RFC 2396, and the unreserved characters. This means thirteen of the reserved characters are encoded, but we can encode a smaller subset in the two following cases.</p>

	<aside>

		<p>1. The WHATWG URL Standard is also relevant <a href="https://github.com/whatwg/url/issues/703">to some extent</a>. A <cite>valid URL string</cite>, as defined by that specification, is not necessarily compatible with software that expects a URI.</p>

		<p>2. Percent-encoding may also be used to conform with external restrictions. A closing parenthesis misinterpreted as the end of a URI could be replaced with <q><code>%29</code></q>, but this is not ideal. Encoding reserved characters can easily change the meaning of a URI, so it's better to use environment specific escape sequences like <q><code>&amp;amp;</code></q> or <q><code>\'</code></q>.</p>

	</aside>

	<h4>Data URIs</h4>

	<p><a href="https://www.rfc-editor.org/info/rfc2397">RFC 2397</a> states that the main content section of a data URI will consist of zero or more <var>urlchar</var> characters, and that these characters are defined in RFC 2396. The definition is restated below as <var>2396-uric</var>, and allows any percent-encoded or unreserved character, in addition to all but <q><code>#[]</code></q> of the reserved characters.</p>

	<p><code>unreserved = '-' | '.' | [0-9] | [A-Z] | '_' | [a-z] | '~'<br/>2396-reserved = '$' | '&amp;' | '+' | ',' | '/' | ':' | ';' | '=' | '?' | '@'<br/>previously-unreserved = '!' | ''' | '(' | ')'| '*'<br/>3986-reserved = '#' | '[' | ']' | 2396-reserved | previously-unreserved<br/>hex = [0-9] | [A-F] | [a-f]<br/>escaped = '%' hex hex<br/>encodeURIComponent = unreserved | previously-unreserved | escaped<br/>2396-uric = 2396-reserved | encodeURIComponent<br/>encodeURI = '#' | 2396-uric</code></p>

	<p>This more formal description of the character sets shows that every character in the output of <cite>encodeURI()</cite> will either be the number sign U+23 or a <var>urlchar</var> character. This means we can call <cite>encodeURI()</cite>, then replace all occurrences of <q><code>#</code></q> with <q><code>%23</code></q>, and the output will be valid within a data URI.</p>

	<p>The code below shows how an SVG data URI might be constructed using JavaScript.<sup>3</sup></p>

	<pre><code>const rectSVG = String.raw`&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">&#xA;&#x9;&lt;rect fill="#69E" x="20" y="20" width="15.2" height="87"/>&#xA;&#x9;&lt;text fill="Gray" x="19" y="19">\o/&lt;/text>&#xA;&lt;/svg>`;&#xA;const rectDataURI = 'data:image/svg+xml,' + encodeURI(rectSVG).replaceAll('#', '%23');</code></pre>

	<p>The resulting string is <q><code>data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20128%20128%22%3E%0A%09%3Crect%20fill=%22%2369E%22%20x=%2220%22%20y=%2220%22%20width=%2215.2%22%20height=%2287%22/%3E%0A%09%3Ctext%20fill=%22Gray%22%20x=%2219%22%20y=%2219%22%3E%5Co/%3C/text%3E%0A%3C/svg%3E</code></q>.</p>

	<p>The WHATWG has published a <a href="https://fetch.spec.whatwg.org/#data-urls">section on data URLs</a>. If you write a <cite>valid URL string</cite>, it will be converted to a <cite>URL record</cite> by the <cite>URL parser</cite> before being processed as a data URL. This processing discards the fragment component of the URL, which begins after U+23 (#), so leaving a number sign unencoded will cut the data short. The rest of the <cite>valid URL string</cite> may include the following parts: <q><code>data:</code></q>, <cite>URL-path-segment string</cite>, U+2F (/), U+3F (?), <cite>URL-query string</cite>. All of these parts are formed from <cite>URL units</cite>, which is a set of characters equal to <var>2396-uric</var> plus <a href="https://url.spec.whatwg.org/#url-code-points">most non-ASCII Unicode characters</a>. The fact that the <cite>URL parser</cite> splits a data URL into parts has no effect on the data. You can leave forward slash and question mark delimiters unencoded, as the parts will be rejoined by the <cite>URL serializer</cite> during data URL processing.</p>

	<p>In this case, both the RFC 2397 and WHATWG definitions of validity treat ASCII characters in effectively the same way. The difference is that the WHATWG allows unencoded non-ASCII.</p>

	<aside>

		<p>3. <cite>String.raw()</cite> is helpful if the data contains backslashes, but if it contains backticks or the substring <q><code>${</code></q> then you can no longer simply paste the data into a template literal.</p>

		<pre>String.raw`_\`_\${_${"`"}_` === "_\\`_\\${_`_"</pre>

	</aside>

	<h4>Query Strings</h4>

	<p>From RFC 3986 Section 3.4:</p>

	<blockquote cite="https://www.rfc-editor.org/rfc/rfc3986.html#section-3.4">The query component is indicated by the first question mark ("?") character and terminated by a number sign ("#") character or by the end of the URI.</blockquote>

	<p>Continuing the description of character sets from the Data URIs section, we can add the definition for URI query components as given in RFC 3986.</p>

	<p><code>sub-delims = '!' | '$' | '&amp;' | ''' | '(' | ')' | '*' | '+' | ',' | ';' | '='<br/>3986-pchar = ':' | '@' | unreserved | escaped | sub-delims<br/>query = *( '/' | '?' | 3986-pchar )</code></p>

	<p>It turns out that the characters allowed within the query are exactly the <var>2396-uric</var> characters.</p>
	
	<p>A method to store data within the query is not specified in RFC 3986, but usually the characters <q><code>&amp;+=</code></q> have special purposes. By reading the query contents with something like the JavaScript <cite>URLSearchParams</cite> interface, you interpret the query string as a set of <q>key=value</q> pairs. These pairs are separated by U+26 (&amp;) ampersands, and U+2B (+) plus signs are used throughout the string to represent spaces. See the WHATWG's definition of the <a href="https://url.spec.whatwg.org/#concept-urlencoded-parser"><code>application/x-www-form-urlencoded</code> parser</a> for an exact description of this process.</p>

	<p>The equals sign U+3D (=) needs to be encoded within the key portion of a pair, but not in the value portion, as only the first equals sign separates the two parts. Encode the data as you would for a data URI, then handle these three special characters, and as a final step we can change the encoding of U+20 spaces from <q><code>%20</code></q> to <q><code>+</code></q>.</p>

	<pre>const style = `background-image:url("${rectDataURI}");color-scheme:light dark`;&#xA;const vertices = '[[1,0],[0.58,0.58],[0,1],[-0.58,0.58],[-1,0],[-0.58,-0.58],[0,-1],[0.58,-0.58]]';&#xA;&#xA;function encodeQueryValue(val) {&#xA;&#x9;return encodeURI(val).replace(/[#&amp;+]|%20/g, char => ({&#xA;&#x9;&#x9;'#': '%23',&#xA;&#x9;&#x9;'&amp;': '%26',&#xA;&#x9;&#x9;'+': '%2B',&#xA;&#x9;&#x9;'%20': '+'&#xA;&#x9;}[char]));&#xA;}&#xA;&#xA;const query = `?v=${encodeQueryValue(vertices)}&amp;i=${encodeQueryValue(style)}&amp;h=6`;&#xA;const mirrorPolygonURI = 'https://home.6t.lt/66c/mirror-polygon.svg' + query;</pre>

	<p>The above code generates the URI <q><code>https://home.6t.lt/66c/mirror-polygon.svg?v=%5B%5B1,0%5D,%5B0.58,0.58%5D,%5B0,1%5D,%5B-0.58,0.58%5D,%5B-1,0%5D,%5B-0.58,-0.58%5D,%5B0,-1%5D,%5B0.58,-0.58%5D%5D&amp;i=background-image:url(%22data:image/svg%2Bxml,%253Csvg%2520xmlns=%2522http://www.w3.org/2000/svg%2522%2520viewBox=%25220%25200%2520128%2520128%2522%253E%250A%2509%253Crect%2520fill=%2522%252369E%2522%2520x=%252220%2522%2520y=%252220%2522%2520width=%252215.2%2522%2520height=%252287%2522/%253E%250A%2509%253Ctext%2520fill=%2522Gray%2522%2520x=%252219%2522%2520y=%252219%2522%253E%255Co/%253C/text%253E%250A%253C/svg%253E%22);color-scheme:light+dark&amp;h=6</code></q>.</p>

	<p>If you want to encode the whole query string at once, instead of individual values, then the reserved characters to be encoded are <q><code>#+[]</code></q>. You can't encode all ampersands and equals signs as they may be present and acting as delimiters. Any U+26 (&amp;) or U+3D (=) characters intended as data would be manually encoded if necessary, and all of this encoding must be done after using something like <cite>encodeURI()</cite> to avoid double encoding.</p>

	<p>Just as with data URLs, you can leave most non-ASCII characters unencoded in the query component while still complying with the WHATWG's rules for writing URLs.</p>

	<h4>Endnotes</h4>

	<p>As of writing, there is an <a href="https://github.com/whatwg/url/issues/753">open issue</a> on the WHATWG URL Standard's GitHub page in support of unescaped square brackets. The definition of a <cite>valid URL string</cite> may change in the future, as some ASCII characters are frequently used in URLs despite being disallowed.</p>

	<p>The <a href="https://alwinb.github.io/url-specification">URL Specification</a> by Alwin Blok is a condensed description of URLs which I found helpful.</p>

	<p>I also wrote a <a href="https://home.6t.lt/698/query-encoding.html">webpage comparing encoding methods</a> for data within a query value.</p>

</section>

<section class="changelog">

	<h3>End of 2024 Changes</h3>

	<ul>
		<li>Made a basic <a href="https://home.6t.lt/shortcuts/">HTML Viewer</a> webpage, as an alternative to an HTML data URI. I've set it up at the domain '6t.lt': <a class="naked" href="https://6t.lt?b=Your+HTML+content+here">link</a>.</li>
		<li>Started posting bike ride plans for around Amherst on my <a href="https://bike.6t.lt/">cycling repository GitHub page</a>.</li>
		<li>Uploaded an <a href="https://home.6t.lt/66d/umass-rmc-logo.svg">SVG version</a> of the UMass Recreational Math Club logo.</li>
	</ul>

</section>