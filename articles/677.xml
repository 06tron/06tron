<p>With the book club this past semester I read Daphne du Maurier's <cite><a href="https://www.wikidata.org/wiki/Q1334940">Rebecca</a></cite>, Gerald Durrell's <cite><a href="https://www.wikidata.org/wiki/Q1394009">My Family and Other Animals</a></cite>, and most of <a href="https://www.wikidata.org/wiki/Q3993282">Tony Mendez's</a> <cite>Argo</cite>. I also read Cormac McCarthy's <cite><a href="https://www.wikidata.org/wiki/Q264519">All the Pretty Horses</a></cite>.</p><section class="software web" id="percent_encode_677"><h3><span class="fl">Percent-Encoding Guide</span></h3><p>According to <a href="https://www.rfc-editor.org/info/std66">STD 66 RFC 3986</a>, the characters of the string <q><code>!#$&amp;'()*+,/:;=?@[]</code></q> could have a special meaning in a URI and are reserved. The <a href="https://infra.spec.whatwg.org/#ascii-alphanumeric">ASCII alphanumeric</a> characters and those contained in <q><code>-._~</code></q> are unreserved. Any character outside of these two sets must be percent-encoded before inclusion in a URI. This is what the JavaScript <cite>encodeURI()</cite> function does, except that it also encodes the square brackets <q><code>[]</code></q>, which were not yet included in the set of URI characters when the superseded <a href="https://www.rfc-editor.org/info/rfc2396">RFC 2396</a> was written.</p><p>The unreserved characters can always be left unencoded, so we just need to encode some subset of the reserved characters. This subset depends on the URI scheme being used and where in the URI the characters are. The function <cite>encodeURIComponent()</cite> encodes everything except for the characters of <q><code>!'()*</code></q>, which often don't need to be encoded as they weren't yet reserved in RFC 2396, and the unreserved characters. This means thirteen of the reserved characters are encoded, but we can encode a smaller subset in the following cases.</p><h4>Data URIs</h4><p><a href="https://www.rfc-editor.org/info/rfc2397">RFC 2397</a> states that the main content section of a data URI will consist of some number of 'uric' characters, and that these characters are defined in RFC 2396. According to that definition, any percent-encoded or unreserved character is allowed, in addition to all but <q><code>#[]</code></q> of the reserved characters.</p><p><code>unreserved = '-' | '.' | [0-9] | [A-Z] | '_' | [a-z] | '~'<br/>2396-reserved = '$' | '&amp;' | '+' | ',' | '/' | ':' | ';' | '=' | '?' | '@'<br/>previously-unreserved = '!' | ''' | '(' | ')'| '*'<br/>3986-reserved = '#' | '[' | ']' | 2396-reserved | previously-unreserved<br/>hex = [0-9] | [A-F] | [a-f]<br/>escaped = '%' hex hex<br/>encodeURIComponent = unreserved | previously-unreserved | escaped<br/>2396-uric = 2396-reserved | encodeURIComponent<br/>encodeURI = '#' | 2396-uric</code></p><p>Above is a more formal description of the character sets. It shows that every character in the output of <cite>encodeURI()</cite> will either be the number sign U+23 or a 'uric' character. This means we can call <cite>encodeURI()</cite>, then replace all occurrences of <q><code>#</code></q> with <q><code>%23</code></q>, and the output will be valid within a data URI.</p><p>The code below shows how an SVG data URI might be constructed using JavaScript.</p><pre>const rectSVG = String.raw`&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
	&lt;rect fill="#69E" x="20" y="20" width="15.2" height="87"/>
	&lt;text fill="Gray" x="19" y="19">\o/&lt;/text>
&lt;/svg>`;
const rectDataURI = 'data:image/svg+xml,' + encodeURI(rectSVG).replaceAll('#', '%23');</pre><p>The resulting string is <q><code>data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20128%20128%22%3E%0A%09%3Crect%20fill=%22%2369E%22%20x=%2220%22%20y=%2220%22%20width=%2215.2%22%20height=%2287%22/%3E%0A%09%3Ctext%20fill=%22Gray%22%20x=%2219%22%20y=%2219%22%3E%5Co/%3C/text%3E%0A%3C/svg%3E</code></q>.</p><p>Note that <cite>String.raw()</cite> is helpful if the data contains backslashes, but if it contains backticks or the substring <q><code>${</code></q> then you can no longer simply paste the data into a template literal.</p><pre>String.raw`_\`_\${_${"`"}_` === "_\\`_\\${_`_"</pre><h4>Query Strings</h4><p>The query part of a URI begins after a question mark. It is composed of the 'query' characters defined in RFC 3986, and these are exactly the same as the 'uric' characters. However, the characters <q><code>&amp;+=</code></q> have special purposes. The query string is a set of 'key=value' pairs, separated by ampersands, and in which plus signs represent spaces. The equals sign needs to be encoded in the 'key' portion, but not in the 'value' portion as only the first equals sign separates the two parts. Encode the data as you would for a data URI, then handle these three special characters, and as a final step we can change the encoding of spaces from <q><code>%20</code></q> to <q><code>+</code></q>. <a href="data:text/html;charset=UTF-8,%22%20!%23$&amp;'()*+,/:;=?@%5B%5D%22%3Cbr%3E%3Ca%20href=%22data:,%2522%2520!%2523$&amp;'()*+,/:;=?@%255B%255D%2522%22%3Ein%20data%20URI%3C/a%3E%3Cbr%3E%3Ca%20href=%22https://6t.lt/?b=%2522+!%2523$%2526%2527()*%252B,/:;=?@%255B%255D%2522%22%3Ein%20query%20string%3C/a%3E">This data URI</a> contains two links which compare the encoding of the reserved characters and the space character in a data URI and in a query string.</p><pre>const style = 'background-image:url("${rectDataURI}");color-scheme:light dark';
const vertices = '[[1,0],[0.58,0.58],[0,1],[-0.58,0.58],[-1,0],[-0.58,-0.58],[0,-1],[0.58,-0.58]]';

function encodeQueryValue(val) {
	return encodeURI(val).replace(/[#&amp;'+]|%20/g, char => ({
		'#': '%23',
		'&amp;': '%26',
		"'": '%27',
		'+': '%2B',
		'%20': '+'
	}[char]));
}

const query = `?v=${encodeQueryValue(vertices)}&amp;i=${encodeQueryValue(style)}&amp;h=6`;
const mirrorPolygonURL = 'https://home.6t.lt/66c/mirror_polygon.svg' + query;</pre><p>The above code also encodes the single quote character, as <a href="https://github.com/whatwg/url/issues/348">this</a> GitHub issue suggests doing so in some cases. The code generates the URL <q><code>https://home.6t.lt/66c/mirror_polygon.svg?v=%5B%5B1,0%5D,%5B0.58,0.58%5D,%5B0,1%5D,%5B-0.58,0.58%5D,%5B-1,0%5D,%5B-0.58,-0.58%5D,%5B0,-1%5D,%5B0.58,-0.58%5D%5D&amp;i=background-image:url(%22data:image/svg%2Bxml,%253Csvg%2520xmlns=%2522http://www.w3.org/2000/svg%2522%2520viewBox=%25220%25200%2520128%2520128%2522%253E%250A%2509%253Crect%2520fill=%2522%252369E%2522%2520x=%252220%2522%2520y=%252220%2522%2520width=%252215.2%2522%2520height=%252287%2522/%253E%250A%2509%253Ctext%2520fill=%2522Gray%2522%2520x=%252219%2522%2520y=%252219%2522%253E%255Co/%253C/text%253E%250A%253C/svg%253E%22);color-scheme:light+dark&amp;h=6</code></q>.</p><p>If you want to encode the whole query string at once, then the reserved characters to be encoded are <q><code>#'+[]</code></q>, and any ampersands or equals signs could be manually encoded if necessary. Just remember that all extra encoding has to be done after using <cite>encodeURI()</cite> to avoid double encoding.</p><p>Since the square brackets were more recently reserved, I thought they might be allowed in data URIs, but as of now a link like <code>&lt;a href="data:,%23[]">#[]&lt;/⁠a></code> is flagged for an illegal character error by the W3C markup validator. I saw a few GitHub issues like <a href="https://github.com/whatwg/url/issues/753">this one</a> in support of unescaped square brackets, so they may be allowed in the future.</p></section><section class="changelog"><h3>End of 2024 Changes</h3><ul><li>Made a basic <a href="https://home.6t.lt/shortcuts/">HTML Viewer</a> webpage, as an alternative to an HTML data URI. I've set it up at the domain '6t.lt': <a class="naked" href="https://6t.lt?b=Your+HTML+content+here">link</a>.</li><li>Started posting bike ride plans for around Amherst on my <a href="https://bike.6t.lt/">cycling repository GitHub page</a>.</li><li>Uploaded an <a href="https://home.6t.lt/66d/umass-rmc-logo.svg">SVG version</a> of the UMass Recreational Math Club logo.</li></ul></section>